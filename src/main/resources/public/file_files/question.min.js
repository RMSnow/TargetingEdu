OT2.Basket=function(){function e(t){return this instanceof e?(OT2.Event.call(this),this.el=t||document.createElement("div"),this.$el=$(this.el),this.$list=this.$el.find(".basket-count"),this.isVisible=this.$el.hasClass("active"),this.activeClass="active",this.model=[],this.cacheObj=[],this.unserialize(),this.render(),this.bindEvent(),void(this.wireIframe=OT2.Wireiframe())):new e(t)}var t=_.template(OT2.Util.Template().get("basketList"));return e.prototype={changeVisual:function(){this.isVisible=!this.isVisible,this.$el[this.isVisible?"addClass":"removeClass"](this.activeClass)},bindEvent:function(){var e=this;this.$el.find(".basket-tit").on("click",function(){e.changeVisual()}),e.subscribe("Question:add",function(t){return!_.contains(e.model,t.id)&&(e.model.push(t.id),e.cacheObj[t.id]={id:t.id,type:t.type,xd:t.xd,xk:t.xk},void e.serialize())}),e.subscribe("Question:move",function(t){e.wireIframe.move(t,e)}),e.subscribe("Question:remove",function(t){e.model=_.without(e.model,t.id),e.cacheObj[t.id]&&delete e.cacheObj[t.id],e.serialize()})},getPosition:function(){var e=this.$el.offset(),t=this.$el.width();this.$el.height();return{left:e.left+t,top:e.top}},serialize:function(){OT2.LocalData.set("basket_cacheObj",JSON3.stringify(this.cacheObj)),this.render()},unserialize:function(){var e=this;this.cacheObj={};try{this.cacheObj=JSON3.parse(OT2.LocalData.get("basket_cacheObj"))||{}}catch(t){}this.model=[],_.each(this.cacheObj,function(t){e.model.push(t.id)})},render:function(){this.$list.empty();for(var e,i={},s=0,n=0;e=this.model[n++];){var a=this.cacheObj[e];if(a&&("undefined"==typeof OT2.xd_chid||a.xk==OT2.xd_chid.chid&&a.xd==OT2.xd_chid.xd)){var d=a.type;"undefined"==typeof i[d]?i[d]=[e]:i[d].push(e),s++}}var o=_.map(i,function(e,t){return{key:t,val:e,id:1e3}});if("undefined"!=typeof PARAMS&&PARAMS.question_types){var l=_.invert(PARAMS.question_types);o=_.map(i,function(e,t){var i=l[t]?Number(l[t]):1e3;return{key:t,val:e,id:i}}),o=o.sort(function(e,t){return e.id-t.id})}this.$list.append(t({num:s,list:o}))},getLenght:function(e){var t=0;for(var i in e)t++;return t},removeAll:function(e){var t=this,i=[].slice.call(arguments,1),s=dialog({title:"友情提示",content:'你确定要删除"'+e+'"吗?',padding:20,okValue:"确定",cancelValue:"取消",ok:function(){_ids=_.map(i,function(e){return e+""}),t.model=_.difference(t.model,i),t.model=_.difference(t.model,_ids);for(var s,n=0;s=i[n++];)t.publish("remove:byid",s),delete t.cacheObj[s];t.deleteQtypeWithXdXk(e),t.serialize()},cancel:function(){this.close()}});s.showModal()},deleteQtypeWithXdXk:function(e){var t="";if("undefined"!=typeof OT2.xd_chid){var i=OT2.xd_chid.xd,s=OT2.xd_chid.chid,t=["paper2016",i,s].join(":"),n=OT2.LocalData.get(t);if(!n||0==n.length)return!1;var a={};try{a=JSON3.parse(n)||{}}catch(d){}"undefined"!=typeof a.types&&"undefined"!=typeof a.types[e]&&(delete a.types[e],OT2.LocalData.set(t,JSON3.stringify(a)))}}},_.extend(e.prototype,OT2.Event.prototype),e}(),OT2.Wireiframe=function(){var e=null;return function(){return e||(e={$el:$("<div>"),init:function(){this.$el.css({position:"absolute",display:"none"}),this.$el.appendTo(document.body)},move:function(e,t){var i=e.$el,s=i.position(),n=i.width(),a=i.height();this.$el.css({width:n,height:a,left:s.left,top:s.top,opacity:1}),this.$el.show();var d=t.getPosition();d.width=0,d.height=0,this.$el.append(i.clone(!1));var o=Math.abs(d.left-s.left),l=Math.abs(d.top-s.top),h=Math.sqrt(o*o+l*l)/2.5;this.$el.animate(d,h,function(){$(this).empty(),$(this).hide()})}}),e.init(),e}}(),OT2.Question=function(){var e=_.template(OT2.Util.Template().get("question-item")),t=_.template(OT2.Util.Template().get("exam-point")),i=_.template(OT2.Util.Template().get("exam-answer")),s=_.template(OT2.Util.Template().get("exam-explanation")),n=function(e,t){this.basket=t,this.model={added:!1},"undefined"!=typeof e.added&&(this.model.added=e.added),_.extend(this.model,e),this.$el=null,this.$addBtn=null,this.visibled_analyticbox=!1,this.rendered_analyticbox=!1};return n.prototype={render:function(t){var i=this;if(t)this.$el=t,this.basket.subscribe("question:width",function(){i.$el.find(".exam-s").each(function(){OT2.Util.calcItemWidth($(this))})});else{var s=$(e(this.model)),n=new OT2.QuestionTxt(this.model,this.basket);n.render(),s.find(".exam-head").after(n.$el),this.$el=s}return this.cacheElements(),this.bindEvent(),this},show_analyticbox:function(){var e="undefined"==typeof USER?{uid:null}:USER;if(this.rendered_analyticbox===!1){this.rendered_analyticbox=!0,this.$el.find(".exam-foot").before('<div class="analyticbox-brick"></div>');var n=t({q:this.model,user:e});this.$el.find(".analyticbox-brick").append(n),"7"==this.model.question_type?(n=_.map(this.model.list,function(t,s){return i({q:t,user:e})}),this.$el.find(".exam-qlist > .exam-con").each(function(e,t){$(this).after(n[e])})):(this.$el.find(".analyticbox-brick").addClass("analyticbox-brick-normal"),n=i({q:this.model,user:e}),this.$el.find(".analyticbox-brick").append(n)),n=s({q:this.model,user:e}),this.$el.find(".analyticbox-brick").append(n),this.$el.addClass(this.model.explanation?"beauty-man":"uglify-man")}this.$el[this.visibled_analyticbox?"addClass":"removeClass"]("visible-ake"),this.$el.find(".analyticbox, .analyticbox-brick")[this.visibled_analyticbox?"show":"hide"]()},cacheElements:function(){this.$addBtn=this.$el.find(".J_AddQuestion")},addToBasket:function(){this.model.added=!0,this.$addBtn.html("<b>-</b>移除"),this.$addBtn.addClass("removebtn"),this.$addBtn.removeClass("addbtn")},removeFromBasket:function(){this.model.added=!1,this.$addBtn.html("<b>+</b>选题"),this.$addBtn.removeClass("removebtn"),this.$addBtn.addClass("addbtn")},addOrRemove:function(e){if(!this.model.added||e&&"undefined"!=typeof e){var t=this.countQnumsByChid();if("undefined"==typeof USER.basketLimit&&(USER.basketLimit=30),t>=USER.basketLimit){var i="抱歉，您的试题篮最多可选"+USER.basketLimit+"道试题";return USER.isVip||0!=USER.school_permit_id||(i+='</br><span style="color:#666666;font-size:12px">vip用户可选50道试题，<a href="/payment/vip" target="_blank" class="notice-pjq">开通vip</a><span>'),OT2.Util.alert(i,1),!1}this.addToBasket(),this.basket.publish("Question:add",this.model),this.basket.publish("Question:move",this)}else this.removeFromBasket(),this.basket.publish("Question:remove",this.model)},countQnumsByChid:function(){return"undefined"!=typeof OT2.xd_chid?_.filter(this.basket.cacheObj,function(e){return e.xk==OT2.xd_chid.chid&&e.xd==OT2.xd_chid.xd}).length:this.basket.model.length},bindEvent:function(){var e=this;this.$addBtn.on("click",function(){e.addOrRemove()}),this.basket.subscribe("remove:byid",function(t){return t==e.model.id&&(e.basket.model=_.without(e.basket.model,t),e.basket.model=_.without(e.basket.model,""+t),void e.removeFromBasket())}),this.$el.find(".search-exam").children(".exam-con").on("click",function(t){e.visibled_analyticbox=!e.visibled_analyticbox,e.show_analyticbox()}),this.basket.subscribe("show-analyticbox",function(t){e.visibled_analyticbox=t,e.show_analyticbox()})}},n}();