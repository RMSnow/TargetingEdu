var _util=OT2.Util,Field=OT2.Field;OT2.UserForm=function(){function t(t){var e=dialog({title:"提示",content:_.template(OT2.Util.Template().get("send-email"),{content:t}),okValue:"确定",cancelValue:"关闭",ok:function(){},cancel:function(){}});e.showModal()}var e=function(){var t=document.createElement("input");"undefined"==typeof t.placeholder&&$(".placeholder").each(function(){var t=$(this);t.show();var e=t.next("input");e.on("keyup focus",function(){var e=$.trim(this.value);t[e?"hide":"show"]()}).on("blur",function(){var e=$.trim(this.value);e||t.show()}).trigger("keyup")})},i=function(){this.errors=[],this.checkFields=[]};i.prototype={checkForm:function(){this.errors=[];for(var t,e=0;t=this.checkFields[e++];){var i=t.checkIt();i&&this.errors.push(i)}return!this.errors.length},addField:function(t){this.checkFields.push(t)},initCheckField:function(){},bindOnFocus:function(){for(var t,e=0;t=this.checkFields[e++];)t.addRule("focus",function(){this.removeError()},!1)},bindEvent:function(){},init:function(){return this.initCheckField(),this.bindOnFocus(),this.bindEvent(),this}};var n=function(){return this instanceof n?(this.$form=$("#login-form"),this.returnurl=null,void i.call(this)):new n};_.extend(n.prototype,i.prototype),_.extend(n.prototype,{initCheckField:function(){var t=new Field("#account");t.addRule("blur",function(t){if(t.length<=0)return"账号不能为空！"}),this.addField(t),t=new Field("#password"),t.addRule("blur",function(t){if(t.length<=0)return"密码不能为空！"}),this.addField(t)},clearError:function(){for(var t,e=0;t=this.checkFields[e++];)t.removeError()},bindEvent:function(){var t=this;this.ajaxLoginStatus=!1,this.$form.on("submit",function(){if(t.ajaxLoginStatus)return!1;t.ajaxLoginStatus=!0;var e=t.checkForm();return e&&(t.$form.find("button[type=submit]").html("登录中..."),t.ajaxLogin().always(function(){t.ajaxLoginStatus=!1,t.$form.find("button[type=submit]").html("登录")})),!1})},ajaxLogin:function(){var t=this,e=this.$form,i=e.serializeArray();return $.post("/login",i,function(e){if(0==e.errCode){if(t.returnurl)return window.location.href=t.returnurl,!1;window.location.href=window.location.href}else t.checkFields[1].showError(e.message)},"json")}});var r=function(t){_Field=new Field("#password");var e=_Field;_Field.addRule("blur",function(t){if(t.length<=0)return"请输入密码！";if(t.length<6)return"请输入最少6位的登录密码！";var n=i.getVal();return n&&n!=t?"确认密码输入不一致！":void(n&&n==t&&(i.removeError(),e.removeError()))}),t.addField(_Field),_Field=new Field("#password_confirm");var i=_Field;_Field.addRule("blur",function(t){if(t.length<=0)return"请输入确认密码！";if(t.length<6)return"请输入最少6位的登录密码！";var n=e.getVal();return n&&n!=t?"确认密码输入不一致！":void(n&&n==t&&(i.removeError(),e.removeError()))}),t.addField(_Field)},o=function(t){var e=new Field("#mobile");e.addRule("blur",function(t){return t.length<=0?"请输入手机号码！":/^(13[0-9]|15[0-9]|18[0-9]|14[57])\d{8}$/.test(t)?void 0:"手机格式不正确！"}),e.addRule("validate",function(t){var e=this.$el.data("res");if(e==t)return"该手机号码已经被注册过！"}),t.addField(e),e=new Field("#captcha_code"),e.addRule("blur",function(t){return t.length<=0?"请输入验证码！":/^\d{4}$/.test(t)?void 0:"请输入4位验证码！"}),t.addField(e)},a=function(){return this instanceof a?(this.$form=$("#J_RegisterFormByMobile"),void i.call(this)):new a};_.extend(a.prototype,i.prototype),_.extend(a.prototype,{initCheckField:function(){var t=new Field("#mobile");this.mobileField=t,t.addRule("blur validate",function(t){if(t.length<=0)return"请输入手机号码！";if(!/^(13[0-9]|15[0-9]|18[0-9]|14[57])\d{8}$/.test(t))return"手机格式不正确！";var e=this.$el.data("res");return e==t?"该手机号码已经被注册过！":void 0}),this.addField(t),t=new Field("#captcha_code"),t.addRule("blur",function(t){return t.length<=0?"请输入验证码！":/^\d{4}$/.test(t)?void 0:"请输入4位验证码！"}),this.addField(t),r(this)},bindEvent:function(){var t=this;$("#J_getCode").on("click",function(e){var i=t.mobileField.checkIt();return!i&&void OT2.Util.getCode(this)}),this.$form.on("submit",function(){var e=t.checkForm();return!!e})}});var d=function(t){var e=new Field("#account");e.addRule("blur",function(t){return t.length<=0?"请输入邮箱！":/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/.test(t)?void 0:"邮箱格式不对！"}),t.addField(e)},l=function(){return this instanceof l?(this.$form=$("#J_RegisterFormByEmail"),void i.call(this)):new l};_.extend(l.prototype,i.prototype),_.extend(l.prototype,{initCheckField:function(){var e=new Field("#email");e.addRule("blur",function(t){return t.length<=0?"请输入邮箱！":/^\w+((-\w+)|(\.\w+))*\@[A-Za-z0-9]+((\.|-)[A-Za-z0-9]+)*\.[A-Za-z0-9]+$/.test(t)?void 0:"邮箱格式不对！"}),this.addField(e),r(this);var i=this;$("#submit_mail").bind("click",function(){if(!i.checkForm())return!1;var e=$("#email").val(),n=$("#password").val(),r="";$.post("/site/send-email",{email:e,password:n},"json").done(function(i){r=0==i.errCode?'<h1>验证邮箱发送成功</h1><p>请进入邮箱 <a href="'+i.message+'" target="_blank">'+e+"</a> 点击链接激活邮箱</p>":i.message,t(r)}).fail()})}});var u=function(){return this instanceof u?(this.$form=$("#J_RegisterFormByMobile"),void i.call(this)):new u};_.extend(u.prototype,i.prototype),_.extend(u.prototype,{initCheckField:function(){o(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){var e=t.checkForm();return!!e||(alert(t.errors),!1)})}});var s=function(){return this instanceof s?(this.$form=$("#J_RegisterFormByMobile"),void i.call(this)):new s};_.extend(s.prototype,i.prototype),_.extend(s.prototype,{initCheckField:function(){r(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){var e=t.checkForm();return!!e})}});var c=function(){return this instanceof c?(this.$form=$("#J_RegisterFormByEmail"),void i.call(this)):new c};_.extend(c.prototype,i.prototype),_.extend(c.prototype,{initCheckField:function(){d(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){var e=t.checkForm();return!!e})}});var h=function(){return this instanceof h?(this.$form=$("#J_RegisterFormByEmail"),void i.call(this)):new h};return _.extend(h.prototype,i.prototype),_.extend(h.prototype,{initCheckField:function(){r(this)},bindEvent:function(){var t=this;this.$form.on("submit",function(){var e=t.checkForm();return!!e})}}),{initPlaceholder:e,Login:n,MobileRegister:a,EmailRegister:l,GetPasswordByMobileStep1:u,GetPasswordByMobileStep2:s,GetPasswordByEmailStep1:c,GetPasswordByEmailStep3:h}}();